<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="KaiChu"><title>Buildpack Tips and Tricks ｜ KaiChu</title><meta name=description content="2018 年去上海參加 Kubecon 就有聽到過 CNCF 下的 Cloud Native Buildpacks 的專案。回來也有試玩了一下，概念很不錯，那時候可能整個生態系統比較不建全，試玩了一下就放到旁邊去了 不過自從 Google Cloud Next 20' - Hands-on Keynote: Building Trust for Speedy Innovation 中也有場次提到 Google 內部已經使用 Buildpack 的"><meta name=keywords content="Hugo,theme,zozo"><link rel="shortcut icon" href=https://kaichu.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/highlight.css><link rel=stylesheet href=https://kaichu.io/css/add-on.css><link rel=stylesheet href=/css/prism-ghcolors.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://kaichu.io/><span>KaiChu</span></a></h1></div><div class=description><p class=sub_title>Life is unique by how you shape it</p><div class=my_socials><a href=https://github.com/cage1016 title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.instagram.com/cage1016/ title=instagram target=_blank><i class=ri-instagram-fill></i></a>
<a href=https://www.linkedin.com/in/kaichuchung title=linkedin target=_blank><i class=ri-linkedin-fill></i></a>
<a href=https://www.slideshare.net/cagechung title=slideshow target=_blank><i class=ri-slideshow-fill></i></a>
<a href=https://twitter.com/CageChung title=twitter target=_blank><i class=ri-twitter-fill></i></a>
<a href=https://kaichu.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/buildpack-tips-and-tricks/>Buildpack Tips and Tricks</a></h2><span class=date>2021.04.02</span></div><div class="post_content markdown"><p>2018 年去上海參加 Kubecon 就有聽到過 CNCF 下的 <a href=https://buildpacks.io/>Cloud Native Buildpacks</a> 的專案。回來也有試玩了一下，概念很不錯，那時候可能整個生態系統比較不建全，試玩了一下就放到旁邊去了</p><p>不過自從 <a href="https://cloud.withgoogle.com/next/sf/onair?session=SVR227#application-modernization">Google Cloud Next 20' - Hands-on Keynote: Building Trust for Speedy Innovation</a> 中也有場次提到 Google 內部已經使用 Buildpack 的服務，之後就有比較用力的試了一下，也導入到自己的工程流程中</p><blockquote><ul><li>Google Cloud maintains a set of open source buildpacks for building containers to run > on <strong>GKE</strong>，<strong>Anthos</strong>，& <strong>Cloud Run</strong></li><li><strong>Cloud Build</strong> native support for buildpacks</li><li><strong>Cloud Run</strong> direct source deployments w/ buildpacks</li><li><strong>Cloud Shell</strong> has pack pre-installed. App Engine builds via buildpacks</li><li><strong>Cloud Functions</strong> builds via buildpacks</li><li><strong>Cloud Code</strong> deploy to Cloud Run with Buildpacks</li><li><strong>Skaffold</strong> native support for buildpacks</li></ul></blockquote><p>在跟同事分享 buildpack 的時候，同事覺得太複雜了。同樣的動作 <code>Dockerfile</code> 操作比 buildpack 來的容易簡單，那為什麼還需要導入 buildpack 這個東西把事情弄的複雜?</p><p>ps. (先補充一個血淚: 只拿到前人留下來的 container image，沒有任何 <code>Dockerfile</code>, 後序再次開發只有一個慘字，如果一開始使用 buildpack 就不會那麼辛苦)</p><h3 id=cloud-native-buildpacks>Cloud Native Buildpacks</h3><blockquote><p><strong>Cloud Native Buildpacks</strong>
transform your application source code into images that can run on any cloud.</p></blockquote><p>先從 buildpack 的目的來說，它其實是定義了一套如何從程式源始碼建立 container image 的 <a href=https://github.com/buildpacks/spec>buildpacks/spec: Specification for Cloud Native Buildpacks</a></p><blockquote><p>This specification defines interactions between a platform, a lifecycle, a number of buildpacks, and an application</p><ol><li>For the purpose of transforming that application into an OCI image and</li><li>For the purpose of developing or executing automated tests on that application.</li></ol><p>A <strong>buildpack</strong> is software that partially or completely transforms application source code into runnable artifacts.</p><p>A <strong>lifecycle</strong> is software that orchestrates buildpacks and transforms the resulting artifacts into an OCI image.</p><p>A <strong>platform</strong> is software that orchestrates a lifecycle to make buildpack functionality available to end-users such as application developers.</p></blockquote><p>總的來說，buildpack 的目的是建立一個通用的規範， builder (Google, Heroku, Paketo) 除了實作這個規範之外也會增加一些功能來支援自己的產品(如 Google 的 gcr.io/buildpacks/builder:v1 builder 就有支援 Google Cloud function)。一般的情況就是選擇一個自己適合的 builder 直接使用</p><pre><code class=language-sh># Examples:
pack build test_img --path apps/test-app --builder cnbs/sample-builder:bionic
</code></pre><p>當有特別的需求是可以自定義 buildpack 來完成，但開發者也必需依照同樣的規範的來實作自己的 buildpack；也因為 buildpack 需要按照規範來寫，不像 <code>Dockerfile</code> 這樣可以隨便寫(誤)，入門會有一點門檻，但是效益上會體現在如 container image 的安全性，大量產出 container image 的 CI/CD 流程上</p><p>聽起來好像很方便又覺得那邊卡卡的，我來說說一些心得</p><p><strong>Pros</strong></p><ul><li>不用寫 <code>Dcokerfile</code></li><li>一般的情況可以無惱的使用，可以把精力放在商業邏輯上</li><li>container image 的安性性由 builder 幫你處理</li><li>CI/CD 流程的整合: skaffold, cloud build, tekton 都有支援</li></ul><p><strong>Cons</strong></p><ul><li>因為要尊循規範, 自定義的入門門檻還是有一些</li><li>無惱 build container image 看似很美好，遇到 builder (Google, Heroku, Paketo) 不提供的部份就會很難受(踩到的坑後面再說)</li><li>如果想 build 出 container image size 小的部份得看 builder 有沒有支援，(如: paketobuildpacks/builder:tiny)</li></ul><h2 id=坑>坑</h2><p>現在來談談最近遇到的坑，先來看看現在 pack 建議的 builders，有 Google、Heroku 和 Paketo 三個，使用者可以跟據自己的需求選擇適合的 builder</p><pre><code class=language-sh> pack builder suggest
Suggested builders:
	Google:                gcr.io/buildpacks/builder:v1      Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python
	Heroku:                heroku/buildpacks:18              Base builder for Heroku-18 stack, based on ubuntu:18.04 base image
	Heroku:                heroku/buildpacks:20              Base builder for Heroku-20 stack, based on ubuntu:20.04 base image
	Paketo Buildpacks:     paketobuildpacks/builder:base     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Ruby, NGINX and Procfile
	Paketo Buildpacks:     paketobuildpacks/builder:full     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, PHP, Ruby, Apache HTTPD, NGINX and Procfile
	Paketo Buildpacks:     paketobuildpacks/builder:tiny     Tiny base image (bionic build image, distroless-like run image) with buildpacks for Java Native Image and Go
</code></pre><h4 id=坑1-paketobuildpacksbuildertiny>坑1 paketobuildpacks/builder:tiny</h4><blockquote><p>目前不支持 golang module 中使用 private repo</p></blockquote><pre><code class=language-sh>fatal: could not read Username for 'https://github.com': terminal prompts disabled
      Confirm the import path was entered correctly.
      If this is a private repository, see https://golang.org/doc/faq#git_https for additional information.
</code></pre><p>依據 <a href=https://github.com/paketo-buildpacks/go-mod-vendor/issues/3>Private Repository Support · Issue #3 · paketo-buildpacks/go-mod-vendor</a> 中討論的部份，如果是使用 Golang 語言且 Go Module 中有使用到 private repo 就會遇到權限不足的問題，issues 討論中也表示目前並不支持 private repo，不過有提出 <code>pack</code> 可以 inject SSH key (不過我自己是沒有試成功)</p><p>這個只適合想用 buildpack 產出 tiny 大小的 container image (Golang)，不過前提是沒有使用 private repo</p><h4 id=坑2-gcriobuildpacksbuilderv1>坑2 gcr.io/buildpacks/builder:v1</h4><blockquote><p>gcr.io/buildpacks/gcp/run:v1 不包含 <code>/usr/share/zoneinfo</code>，如果 Golang 中有使用到 <code>loc, _ := time.LoadLocation("Asia/Taipei")</code> 會報錯，不過 paketobuildpacks/builder:tiny 的 run image 有阿 !!!!</p></blockquote><p>在我們用 gcr.io/buildpacks/builder:v1 產出 container image 後執行後發現報錯，root cause 是 container image 並不包含 <code>/usr/share/zoneinfo</code> 目錄導致報錯, <code>pack inspect &lt;container-image></code> 後得知 run image 是 gcr.io/buildpacks/gcp/run:v1，而 gcr.io/buildpacks/gcp/run:v1 本身就沒有包含 <code>/usr/share/zoneinfo</code> 目錄，這時候就必需擴充 gcr.io/buildpacks/gcp/run:v1 中安裝 <code>tzdata</code></p><pre><code class=language-dockerfile>FROM gcr.io/buildpacks/gcp/run:v1
USER root
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
  tzdata &amp;&amp; \
  apt-get clean &amp;&amp; \
  rm -rf /var/lib/apt/lists/*
USER cnb
</code></pre><p>產出擴充的 run image</p><pre><code class=language-sh>docker build -t gcr.io/retailbase-dev/ext-run:v1 -f run.Dockerfile .
</code></pre><p>然後在 pack 中代入 擴充後有 run time</p><pre><code class=language-sh>pack build gcr.io/retailbase-dev/retailbase-organizationsvc:$SHORT_SHA --builder gcr.io/buildpacks/builder:v1 --env GOOGLE_BUILDABLE=cmd/organizationsvc/main.go --run-image gcr.io/retailbase-dev/ext-run:v1
</code></pre><h4 id=坑三-gcriocloud-buildersgcloud>坑三 gcr.io/cloud-builders/gcloud</h4><blockquote><p>cloudbuild gcr.io/cloud-builders/gcloud 中有整合 pack 的參數，不過沒有辦法追加 runtime 的設定，就算我們擴充了 run time 也無法代入</p></blockquote><pre><code class=language-sh>gcloud builds submit [[SOURCE] --no-source] [--async] [--no-cache]
        [--disk-size=DISK_SIZE] [--gcs-log-dir=GCS_LOG_DIR]
        [--gcs-source-staging-dir=GCS_SOURCE_STAGING_DIR]
        [--ignore-file=IGNORE_FILE] [--machine-type=MACHINE_TYPE]
        [--region=REGION] [--substitutions=[KEY=VALUE,...]] [--timeout=TIMEOUT]
        [--worker-pool=WORKER_POOL]
        [--config=CONFIG; default=&quot;cloudbuild.yaml&quot;
          | --pack=[builder=BUILDER],[env=ENV],[image=IMAGE]
          | --tag=TAG, -t TAG] [GCLOUD_WIDE_FLAG ...]
</code></pre><p>gcr.io/cloud-builders/gcloud 使用 pack 的相關參數只有 builder, env, 及 image</p><pre><code class=language-yaml> - id: pack build export
    name: gcr.io/cloud-builders/gcloud
    args:
      - builds
      - submit
      - --pack=builder=gcr.io/buildpacks/builder:v1,env=GOOGLE_BUILDABLE=cmd/export/main.go,image=gcr.io/retailbase-dev/retailbase-export:$SHORT_SHA
</code></pre><p>所以就必需透過 <a href=https://github.com/GoogleCloudPlatform/cloud-builders-community>GoogleCloudPlatform/cloud-builders-community: Community-contributed images for Google Cloud Build</a> 中的方式，自行打包 pack 來使用</p><pre><code class=language-yaml>  - name: gcr.io/retailbase-dev/pack:v0.18.0
    args:
      - build
      - gcr.io/retailbase-dev/retailbase-export:$SHORT_SHA
      - --builder=gcr.io/buildpacks/builder:v1
      - --env=GOOGLE_BUILDABLE=cmd/export/main.go
      - --run-image=gcr.io/retailbase-dev/ext-run:v1
</code></pre><p>如何自定義 buildpack 就寫在另一篇文章</p><h3 id=reference>Reference</h3><ul><li><a href=https://buildpacks.io/>Cloud Native Buildpacks</a>: Buildpack 官方網站</li><li><a href=https://github.com/GoogleCloudPlatform/buildpacks>GoogleCloudPlatform/buildpacks: Builders and buildpacks designed to run on Google Cloud&rsquo;s container platforms</a>: Google 版的 buildpack</li><li><a href=https://paketo.io/>Paketo Buildpacks - Paketo Buildpacks</a></li><li><a href=https://devcenter.heroku.com/articles/buildpacks>Buildpacks | Heroku Dev Center</a>: Heroku 版的 Buildpack</li><li><a href=https://cloud.google.com/sdk/gcloud/reference/builds/submit>gcloud builds submit  |  Cloud SDK Documentation  |  Google Cloud</a></li></ul></div><div class=post_footer></div><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i>
<a href=https://kaichu.io/tags/buildpack/>buildpack</a>
<a href=https://kaichu.io/tags/gcp/>gcp</a>
<a href=https://kaichu.io/tags/pack/>pack</a>
<a href=https://kaichu.io/tags/heroku/>heroku</a>
<a href=https://kaichu.io/tags/paketo/>paketo</a></span></div></div></div></div><div class=doc_comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//kaichuio.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>My spiritual home</span></div></footer><script src=https://kaichu.io/js/jquery-3.5.1.min.js></script><link href=https://kaichu.io/css/fancybox.min.css rel=stylesheet><script src=https://kaichu.io/js/fancybox.min.js></script><script src=https://kaichu.io/js/zozo.js></script><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['[[',']]']],processEscapes:!0,processEnvironments:!0,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var b=MathJax.Hub.getAllJax(),a;for(a=0;a<b.length;a+=1)b[a].SourceElement().parentNode.className+=' has-jax'})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-65308340-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/add-on.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css crossorigin=anonymous onload="media!='all'&&(media='all')"><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js crossorigin=anonymous onload="Prism.plugins.autoloader.languages_path='https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/'"></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js crossorigin=anonymous onload="document.querySelectorAll('pre>code').forEach(function(a){a.classList.add('line-numbers')})"></script></body></html>