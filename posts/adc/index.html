<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="KaiChu"><title>Google Announce Application Default Credentials (ADC) ｜ KaiChu</title><meta name=description content="今天 Google 公佈了 Application Default Credentials (ADC)，一個可以讓使用者更方便在 GCP 上去界接其他的需要使用 OAuth 存取的服務如 Google Cloud Storage、Google BigQuery。這對常常寫 GAE 的我來說又更方便了。
在 GCP 專案建立之後，預設會自動產生 Service Accounts， 這些內建的 Service Accounts 在進行 Server to Server 的存取時只需要應用程式本身的認証，直接使用 AppAssertionCredentials 可以不需透過 Flow 來建立 Credentials物件"><meta name=keywords content="Hugo,theme,zozo"><link rel="shortcut icon" href=https://kaichu.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://kaichu.io/><span>KaiChu</span></a></h1></div><div class=description><p class=sub_title>Life is unique by how you shape it</p><div class=my_socials><a href=https://github.com/cage1016 title=github target=_blank><i class=ri-github-fill></i></a><a href=https://www.instagram.com/cage1016/ title=instagram target=_blank><i class=ri-instagram-fill></i></a><a href=https://www.linkedin.com/in/kaichuchung title=linkedin target=_blank><i class=ri-linkedin-fill></i></a><a href=https://www.slideshare.net/cagechung title=slideshow target=_blank><i class=ri-slideshow-fill></i></a><a href=https://twitter.com/CageChung title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=https://kaichu.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/adc/>Google Announce Application Default Credentials (ADC)</a></h2><span class=date>2015.07.21</span></div><div class="post_content markdown"><p>今天 Google 公佈了 <a href=http://googlecloudplatform.blogspot.tw/2015/07/Easier-Auth-for-Google-Cloud-APIs-Introducing-the-Application-Default-Credentials-feature.html>Application Default Credentials (ADC)</a>，一個可以讓使用者更方便在 GCP 上去界接其他的需要使用 OAuth 存取的服務如 <a href=https://cloud-dot-devsite.googleplex.com/storage>Google Cloud Storage</a>、<a href=https://cloud-dot-devsite.googleplex.com/bigquery>Google BigQuery</a>。這對常常寫 GAE 的我來說又更方便了。</p><p>在 GCP 專案建立之後，預設會自動產生 <a href=https://developers.google.com/accounts/docs/OAuth2ServiceAccount>Service Accounts</a>，
這些內建的 Service Accounts 在進行 Server to Server 的存取時只需要應用程式本身的認証，直接使用 <code>AppAssertionCredentials</code> 可以不需透過 <code>Flow</code> 來建立 <code>Credentials</code>物件</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>httplib2</span>
<span class=kn>from</span> <span class=nn>google.appengine.api</span> <span class=kn>import</span> <span class=n>memcache</span>
<span class=kn>from</span> <span class=nn>apiclient.discovery</span> <span class=kn>import</span> <span class=n>build</span>
<span class=kn>from</span> <span class=nn>oauth2client.appengine</span> <span class=kn>import</span> <span class=n>AppAssertionCredentials</span>

<span class=n>credentials</span> <span class=o>=</span> <span class=n>AppAssertionCredentials</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s1>&#39;https://www.googleapis.com/auth/devstorage.full_control&#39;</span><span class=p>)</span>
<span class=n>http</span> <span class=o>=</span> <span class=n>credentials</span><span class=o>.</span><span class=n>authorize</span><span class=p>(</span><span class=n>httplib2</span><span class=o>.</span><span class=n>Http</span><span class=p>(</span><span class=n>memcache</span><span class=p>))</span>
<span class=n>gcs_service</span> <span class=o>=</span> <span class=n>build</span><span class=p>(</span><span class=s1>&#39;storage&#39;</span><span class=p>,</span> <span class=s1>&#39;v1&#39;</span><span class=p>,</span> <span class=n>http</span><span class=o>=</span><span class=n>http</span><span class=p>,</span> <span class=n>developerKey</span><span class=o>=</span><span class=n>DEVELOPER_KEY</span><span class=p>)</span>
</code></pre></div><p>我們可以直接使用 <code>AppAssertionCredentials</code> 產生的 <code>credentials</code> 來建立 <code>gcs_service</code> 連線，這段程式在上傳到 GAE 上可以跑的很好，
不過如果你想要在本地測試的時候就需要特別指定 Server Accounts 的 <code>credentials</code></p><h2 id=service-accounts>Service Accounts</h2><p>Create Service Account</p><ol><li><p>Click <strong>APIs & Auth</strong> > <strong>credential</strong>.</p></li><li><p>Click <strong>Click new Client ID</strong>.</p></li><li><p>Choose <strong>Service Account</strong>.</p></li><li><p>Key type : <strong>P12 Key</strong></p></li><li><p>Click <strong>Create Client ID</strong></p></li><li><p><strong>P12.Key</strong> file will be downloaded. You have to convert <code>p12</code> to <code>pem</code> cause PKCS12 format is not supported by the PyCrypto library.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=o>(</span>openssl pkcs12 -in xxxxx.p12 -nodes -nocerts &gt; privatekey.pem<span class=o>)</span>
</code></pre></div></li></ol><p>在本地測試程式時還需將 <code>--appidentity_email_address</code> 及 <code>--appidentity_private_key_path</code> 帶到 <code>dev_appserver.py</code> 參數中。
如果沒有帶入這二個參數本地測試會得到 <code>401 Unauthorized</code> 的錯誤訊息，不過上傳到 GAE 因為會透過應用程式本身的認証所以不會出錯。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># gae run locally.</span>
dev_appserver.py yaml_or_war_path --appidentity_email_address<span class=o>=</span>&lt;service-account-email&gt; --appidentity_private_key_path<span class=o>=</span>&lt;privatekey.pem-path&gt;
</code></pre></div><h2 id=application-default-credentials-adc>Application Default Credentials (ADC)</h2><p>而 <a href=https://developers.google.com/identity/protocols/application-default-credentials>Application Default Credentials</a> 則提供了更簡便的作法</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>oauth2client.client</span> <span class=kn>import</span> <span class=n>GoogleCredentials</span>
<span class=kn>from</span> <span class=nn>apiclient.discovery</span> <span class=kn>import</span> <span class=n>build</span>

<span class=n>credentials</span> <span class=o>=</span> <span class=n>GoogleCredentials</span><span class=o>.</span><span class=n>get_application_default</span><span class=p>()</span>
<span class=n>gcs_service</span> <span class=o>=</span> <span class=n>build</span><span class=p>(</span><span class=s1>&#39;storage&#39;</span><span class=p>,</span> <span class=s1>&#39;v1&#39;</span><span class=p>,</span> <span class=n>credentials</span><span class=o>=</span><span class=n>credentials</span><span class=p>)</span>
</code></pre></div><p>Application Default Credentials (ADC) 的方式在本地測試時因為直接使用了 <a href=https://cloud.google.com/sdk/gcloud/reference/auth/login>gcloud auth login</a> 的 <code>credentials</code>，所以在開發上更方便更直覺。</p><p>注意事項:</p><ol><li><a href=https://developers.google.com/api-client-library/python/>Google APIs Client Library for Python</a> 中 <code>1.3</code> 以上才支援 default credentials</li><li><code>$ gcloud -v</code> 確認 Google Cloud SDK 版本在 <code>0.9.51</code> 以上，Google App Engine SDK 版本在 <code>1.9.18</code> 以上</li></ol><h2 id=參考資料>參考資料</h2><ul><li><a href=http://googlecloudplatform.blogspot.tw/2015/07/Easier-Auth-for-Google-Cloud-APIs-Introducing-the-Application-Default-Credentials-feature.html>Google Cloud Platform Blog: Easier Auth for Google Cloud APIs. Introducing the Application Default Credentials feature.</a></li><li><a href=https://developers.google.com/identity/protocols/application-default-credentials>Google Application Default Credentials | Google Identity Platform | Google Developers</a></li><li><a href=https://developers.google.com/api-client-library/python/guide/google_app_engine>Using Google App Engine | API Client Library for Python | Google Developers</a></li></ul></div><div class=post_footer></div><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i><a href=https://kaichu.io/tags/apis/>APIs</a>
<a href=https://kaichu.io/tags/gcp/>GCP</a>
<a href=https://kaichu.io/tags/adc/>ADC</a>
<a href=https://kaichu.io/tags/gae/>GAE</a></span></div></div></div></div><div class=doc_comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kaichuio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>My spiritual home</span></div></footer><script src=https://kaichu.io/js/jquery-3.5.1.min.js></script><link href=https://kaichu.io/css/fancybox.min.css rel=stylesheet><script src=https://kaichu.io/js/fancybox.min.js></script><script src=https://kaichu.io/js/zozo.js></script><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}});MathJax.Hub.Queue(function(){var all=MathJax.Hub.getAllJax(),i;for(i=0;i<all.length;i+=1){all[i].SourceElement().parentNode.className+=' has-jax';}});</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-65308340-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>