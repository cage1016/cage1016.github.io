<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="KaiChu"><title>Skaffold debug goland ｜ KaiChu</title><meta name=description content="今年的 Google Cloud Summit 台北場 於 9/24 在內湖萬豪酒店舉行，在主題演講中再次聽到 Cloud Code 的部份也看到比較有感覺的 Live demo
 Cloud Code 隨附的工具能協助您以輕鬆快速的方式編寫、部署及偵錯雲端原生的應用程式。這項產品提供 Visual Studio Code 和 IntelliJ 等 IDE 的擴充功能，方便您在 Kubernetes 上針對程式碼快速進行疊代、偵錯及部署等作業。 Cloud Code 是基於 GoogleContainerTools/skaffold: Easy and Repeatable Kubernetes Development 為基礎上再整合 Visual Studio Code 和 IntelliJ IDE, 讓開發者可以直接在 IDE 上就可以快速開發 Kubernetes 上的應用程式
 基本上來說 Cloud Code 給 Visual Studio Code 和 IntelliJ IDE 的 plugin 就是基於 skaffold 打造的(如下圖)，當你在 Visual Studio Code 執行(cmd+shift+p) Cloud Code: Continues Deploy 的 log 就會知道"><meta name=keywords content="Hugo,theme,zozo"><link rel="shortcut icon" href=https://kaichu.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://kaichu.io/><span>KaiChu</span></a></h1></div><div class=description><p class=sub_title>Life is unique by how you shape it</p><div class=my_socials><a href=https://github.com/cage1016 title=github target=_blank><i class=ri-github-fill></i></a><a href=https://www.instagram.com/cage1016/ title=instagram target=_blank><i class=ri-instagram-fill></i></a><a href=https://www.linkedin.com/in/kaichuchung title=linkedin target=_blank><i class=ri-linkedin-fill></i></a><a href=https://www.slideshare.net/cagechung title=slideshow target=_blank><i class=ri-slideshow-fill></i></a><a href=https://twitter.com/CageChung title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=https://kaichu.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/skaffold-debug-goland/>Skaffold debug goland</a></h2><span class=date>2019.10.04</span></div><div class="post_content markdown"><p>今年的 <a href=https://inthecloud.withgoogle.com/summit-tpe-19/agenda.html>Google Cloud Summit 台北場</a> 於 9/24 在內湖萬豪酒店舉行，在主題演講中再次聽到 <a href=https://cloud.google.com/code>Cloud Code</a> 的部份也看到比較有感覺的 Live demo</p><blockquote><p>Cloud Code 隨附的工具能協助您以輕鬆快速的方式編寫、部署及偵錯雲端原生的應用程式。這項產品提供 Visual Studio Code 和 IntelliJ 等 IDE 的擴充功能，方便您在 Kubernetes 上針對程式碼快速進行疊代、偵錯及部署等作業。
 
Cloud Code 是基於 <a href=https://github.com/GoogleContainerTools/skaffold>GoogleContainerTools/skaffold: Easy and Repeatable Kubernetes Development</a> 為基礎上再整合 Visual Studio Code 和 IntelliJ IDE, 讓開發者可以直接在 IDE 上就可以快速開發 Kubernetes 上的應用程式</p></blockquote><p>基本上來說 Cloud Code 給 Visual Studio Code 和 IntelliJ IDE 的 plugin 就是基於 skaffold 打造的(如下圖)，當你在 Visual Studio Code 執行(cmd+shift+p) <code>Cloud Code: Continues Deploy</code> 的 log 就會知道</p><div class=fancybox><a data-fancybox=gallery href=https://kaichu.io/images/posts/skaffold-go-debug-image-4.png data-caption><img src=https://kaichu.io/images/posts/skaffold-go-debug-image-4.png></a></div><h2 id=cloud-code--debug>Cloud Code & debug</h2><p>在談談 Skaffold debug k8s golang 的程式前，先來看看目前 Cloud Code debug 的部份支援幾種程式語言</p><p><em>Visual Studio Code 中 Cloud code 可以新增的專案範本</em></p><div class=fancybox><a data-fancybox=gallery href=https://kaichu.io/images/posts/skaffold-go-debug-image-5.png data-caption><img src=https://kaichu.io/images/posts/skaffold-go-debug-image-5.png></a></div><blockquote><p>依照官方文件，現在 Cloud Code 有整合 debug 的部份有 <code>Node.js</code>、 <code>Python</code>、<code>Java</code>。 <code>Go</code> 目前不支援, 不過在 skaffold v38.0 的時候終於加進了. (Add Go container debugging support <a href=https://github.com/GoogleContainerTools/skaffold/pull/2306>#2306</a>)，所以就有了這一篇文章。至於本來 Cloud Code 就有整合的語言就依照官方的操作流程應該就可以正常運作，所以這邊就不在說明了</p></blockquote><h2 id=golang-debug--skaffold>Golang debug & skaffold</h2><p>當我們開發 kubernetes 應用程式(golang)會有 remote debug 的需求，在 skaffold v38.0 版之前 remote debug golang 是需要比較複雜的方式(docker-compose or kubernetes))</p><p><strong>之前我們怎麼進行 remote debug golang</strong></p><ol><li>編譯 binary 時需要加入 <code>github.com/derekparker/delve/cmd/dlv</code></li><li>執行 binary 時需要帶入 <code>CMD ["/go/bin/dlv", "--listen=:2345", "--headless=true", "--api-version=2", "exec", "/exe"]</code></li><li>docker-compose & kubernetes YAML 檔都需要加入額外的聲明(完整的 yaml 範例可以看 <a href=https://github.com/cage1016/gokitconsul/blob/master/deployments/docker/docker-compose-debug.yaml#L57-L85>這</a>)<div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>security_opt</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>apparmor:unconfined</span><span class=w>
</span><span class=w></span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>SYS_PTRACE</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div></li><li>需要 port forwarding dlv debug port 到本機</li><li>透過 localhost port forwarding 就可以 attach 到 remote 的 golang</li></ol><p>步驟有一點麻煩</p><p><strong>當 skaffold v38.0 開始支援 container debugging support，事情就變簡單了</strong></p><ol><li>remote debug 還是需要 <code>dlv</code>，不過 skaffold 透過 kubernetes 中的 initContainers 的方式來幫我們載入(Mount)相關的套件(dlv/dbg)，且會自動識別 runtime 來決定載入的套件，需 golang 的部份就在 <code>gcr.io/gcp-dev-tools/duct-tape/go</code>，(其他的 runtime 可由 <a href=https://github.com/GoogleContainerTools/container-debug-support/>https://github.com/GoogleContainerTools/container-debug-support/</a> 查詢)，並且會在 metadata 的 anootation 中加上 <code>debug.cloud.google.com/config: {"addsvc":{"dlv":56268,"runtime":"go"}}</code></li><li>remote debug 還是需要 <code>dlv</code> 相關的啟動參數，skaffold 會自動幫我載入<div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>Containers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>addsvc</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>Container ID</span><span class=p>:</span><span class=w>  </span><span class=l>docker://493a405f1dc0ee462f4e5f269ae2fdb352e8468c186cbb26905c42e0bf5675cf</span><span class=w>
</span><span class=w>        </span><span class=nt>Image</span><span class=p>:</span><span class=w>         </span><span class=l>cage1016/skaffold-debug-go-demo-addsvc:88f846061af2d34e8347a6325dcf48bb638f6baa50fd4599240fa5280054048e</span><span class=w>
</span><span class=w>        </span><span class=nt>Image ID</span><span class=p>:</span><span class=w>      </span><span class=l>docker://sha256:88f846061af2d34e8347a6325dcf48bb638f6baa50fd4599240fa5280054048e</span><span class=w>
</span><span class=w>        </span><span class=nt>Ports</span><span class=p>:</span><span class=w>         </span><span class=m>8020</span><span class=l>/TCP, 8021/TCP, 56268/TCP</span><span class=w>
</span><span class=w>        </span><span class=nt>Host Ports</span><span class=p>:</span><span class=w>    </span><span class=m>0</span><span class=l>/TCP, 0/TCP, 0/TCP</span><span class=w>
</span><span class=w>        </span><span class=nt>Command</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=l>/dbg/go/bin/dlv</span><span class=w>
</span><span class=w>            </span><span class=l>exec</span><span class=w>
</span><span class=w>            </span>--<span class=l>headless</span><span class=w>
</span><span class=w>            </span>--<span class=l>continue</span><span class=w>
</span><span class=w>            </span>--<span class=l>accept-multiclient</span><span class=w>
</span><span class=w>            </span>--<span class=l>listen=localhost:56268</span><span class=w>
</span><span class=w>            </span>--<span class=l>api-version=2</span><span class=w>
</span><span class=w>            </span><span class=l>/exe</span><span class=w>
</span></code></pre></div></li><li>docker-compose & kubernetes YAML <code>不</code>需要再加註其他的聲明</li><li>Cloud Code 上跑 skaffold debug 會自動幫我們建立 port forwarding</li><li>Cloud Code 上進行 deubg 的設定，<div class=highlight><pre class=chroma><code class=language-json data-lang=json>        <span class=p>{</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudcode&#34;</span><span class=p>,</span>
        <span class=nt>&#34;language&#34;</span><span class=p>:</span> <span class=s2>&#34;Go&#34;</span><span class=p>,</span>
        <span class=nt>&#34;request&#34;</span><span class=p>:</span> <span class=s2>&#34;attach&#34;</span><span class=p>,</span>
        <span class=nt>&#34;debugPort&#34;</span><span class=p>:</span> <span class=mi>56268</span><span class=p>,</span>
        <span class=nt>&#34;localRoot&#34;</span><span class=p>:</span> <span class=s2>&#34;${workspaceFolder}/go&#34;</span><span class=p>,</span>
        <span class=nt>&#34;remoteRoot&#34;</span><span class=p>:</span> <span class=s2>&#34;/go/&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;skaffold-debug-go-demo&#34;</span><span class=p>,</span>
        <span class=nt>&#34;podSelector&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;app&#34;</span><span class=p>:</span> <span class=s2>&#34;addsvc&#34;</span>
        <span class=p>}</span>
    <span class=p>}</span>
</code></pre></div></li></ol></div><div class=post_footer><div class="post_content markdown"><h3>See Also</h3><ul><li><a href=/posts/golang-regex/>Golang regEx parse Facebook Live rtmp</a></li><li><a href=/posts/golang-serve-static-site/>golang serving a single page application</a></li></ul></div><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i><a href=https://kaichu.io/tags/kubernetes/>kubernetes</a>
<a href=https://kaichu.io/tags/skaffold/>skaffold</a>
<a href=https://kaichu.io/tags/debug/>debug</a>
<a href=https://kaichu.io/tags/golang/>golang</a>
<a href=https://kaichu.io/tags/vscode/>vscode</a>
<a href=https://kaichu.io/tags/goland/>GoLand</a></span></div></div></div></div><div class=doc_comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kaichuio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>My spiritual home</span></div></footer><script src=https://kaichu.io/js/jquery-3.5.1.min.js></script><link href=https://kaichu.io/css/fancybox.min.css rel=stylesheet><script src=https://kaichu.io/js/fancybox.min.js></script><script src=https://kaichu.io/js/zozo.js></script><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}});MathJax.Hub.Queue(function(){var all=MathJax.Hub.getAllJax(),i;for(i=0;i<all.length;i+=1){all[i].SourceElement().parentNode.className+=' has-jax';}});</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-65308340-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>