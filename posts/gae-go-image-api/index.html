<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="KaiChu"><title>GAE go Image API for GCS ｜ KaiChu</title><meta name=description content="LIVE DEMO
 在開發 GAE 應用程式時，難免會遇到應用程式需要處理圖片的問題。GAE 的應用程用可以直接存取靜態的資源檔案，這塊直接在 app.yaml 檔案中設定就可以了，不過也因為 GAE 應用程式的特性，需要將所有的資源上傳一份到 GAE 正式環境中，所以會發現上傳專案的容量大小會爆增(如果你將所有需要的圖檔階直接放在程式內)。
專案檔案太大會影響 GAE 在自動擴展的效能，所以盡可能的將不必要的東西移多專案外(圖檔等)"><meta name=keywords content="Hugo,theme,zozo"><link rel="shortcut icon" href=https://kaichu.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://kaichu.io/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://kaichu.io/><span>KaiChu</span></a></h1></div><div class=description><p class=sub_title>Life is unique by how you shape it</p><div class=my_socials><a href=https://github.com/cage1016 title=github target=_blank><i class=ri-github-fill></i></a><a href=https://www.instagram.com/cage1016/ title=instagram target=_blank><i class=ri-instagram-fill></i></a><a href=https://www.linkedin.com/in/kaichuchung title=linkedin target=_blank><i class=ri-linkedin-fill></i></a><a href=https://www.slideshare.net/cagechung title=slideshow target=_blank><i class=ri-slideshow-fill></i></a><a href=https://twitter.com/CageChung title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=https://kaichu.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/gae-go-image-api/>GAE go Image API for GCS</a></h2><span class=date>2016.10.31</span></div><div class="post_content markdown"><blockquote><p><a href=https://go-gae-image-api-example-dot-gae-lab-001.appspot.com/>LIVE DEMO</a></p></blockquote><p>在開發 GAE 應用程式時，難免會遇到應用程式需要處理圖片的問題。GAE 的應用程用可以直接存取靜態的資源檔案，這塊直接在 <code>app.yaml</code> 檔案中設定就可以了，不過也因為 GAE 應用程式的特性，需要將所有的資源上傳一份到 GAE 正式環境中，所以會發現上傳專案的容量大小會爆增(如果你將所有需要的圖檔階直接放在程式內)。</p><p>專案檔案太大會影響 GAE 在自動擴展的效能，所以盡可能的將不必要的東西移多專案外(圖檔等)</p><p><em>app.yaml</em></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>/favicon.jpg</span><span class=w>
</span><span class=w>  </span><span class=nt>mime_type</span><span class=p>:</span><span class=w> </span><span class=l>image/x-icon</span><span class=w>
</span><span class=w>  </span><span class=nt>static_files</span><span class=p>:</span><span class=w> </span><span class=l>public/images/favicon.jpg</span><span class=w>
</span><span class=w>  </span><span class=nt>upload</span><span class=p>:</span><span class=w> </span><span class=l>public/images/favicon.jpg</span><span class=w>
</span><span class=w> 
</span><span class=w></span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>/js/*</span><span class=w>
</span><span class=w>  </span><span class=nt>mime_type</span><span class=p>:</span><span class=w> </span><span class=l>text/javascript</span><span class=w>
</span><span class=w>  </span><span class=nt>static_dir</span><span class=p>:</span><span class=w> </span><span class=l>public/js</span><span class=w>
</span><span class=w>  </span><span class=nt>secure</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w> 
</span><span class=w></span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>/css/*</span><span class=w>
</span><span class=w>  </span><span class=nt>mime_type</span><span class=p>:</span><span class=w> </span><span class=l>text/css</span><span class=w>
</span><span class=w>  </span><span class=nt>static_dir</span><span class=p>:</span><span class=w> </span><span class=l>public/css</span><span class=w>
</span><span class=w>  </span><span class=nt>secure</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w>  </span><span class=nt>http_headers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>Access-Control-Allow-Origin</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w> 
</span><span class=w></span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>/images/*</span><span class=w>
</span><span class=w>  </span><span class=nt>static_dir</span><span class=p>:</span><span class=w> </span><span class=l>public/images</span><span class=w>
</span><span class=w>  </span><span class=nt>secure</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></code></pre></div><p>每一個 GCP 的專案可以有 <code>5G</code> 免費的 Google Cloud Storage 空間，所以將 GAE 上大檔案的靜態資源放到 GCS 是一個很好的決定，在 GAE 程式中可以使用 <code>google-api-go-client</code> 來存取 GCS 上相關的資源。如果是圖片檔的話，更可以直接用 Image API 的方式來直接讀取圖片資源</p><p><a href=https://cloud.google.com/appengine/docs/go/images/>Images Go API</a> 讓我們使用 <code>Blobstore</code> 的方式來讀取/裁切圖檔，當我們透過 Blobstore 拿到靜態圖檔時可以直接透過 url 的方式對目標圖片進行調整圖檔的大小或進行裁切</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># 將目標圖片重新縮放至 32 像素(等比例 - 長邊)
http://lhx.ggpht.com/randomStringImageId=s32
 
# 將照片裁切至 32 像素
http://lhx.ggpht.com/randomStringImageId=s32-c
</code></pre></div><h2 id=imgserve>imgServe</h2><p>因些我們就可以設計一個動態的路由來對應至 GCS 上特定路徑的圖片</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>/img?f=dress/banner.png --&gt; GCS:Bucket/dress/banner.png
/img?f=dress/color/banner.png --&gt; GCS:Bucket/dress/color/banner.png
/img?f=dress/color/banner.png&amp;s=200 --&gt; GCS:Bucket/dress/color/banner.png 等比縮放至 200 像素
/img?f=dress/color/banner.png&amp;s=200-c --&gt; GCS:Bucket/dress/color/banner.png 等比縮放至 200 像素且進行 1:1 的裁切
</code></pre></div><p>如此一來前端面頁如果需要引用照片，可以直接使用 <code>&lt;img src="/img?f=dress/banner.png" alt=""></code>，如果目標圖片不存在則直接輸入一開始就準備好的 image 404 圖片進行代替</p><p><em>main.go</em></p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>
 
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;golang.org/x/net/context&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
 
	<span class=s>&#34;github.com/labstack/echo&#34;</span>
	<span class=s>&#34;github.com/labstack/echo/engine/standard&#34;</span>
 
	<span class=s>&#34;google.golang.org/appengine&#34;</span>
	<span class=s>&#34;google.golang.org/appengine/blobstore&#34;</span>
	<span class=s>&#34;google.golang.org/appengine/image&#34;</span>
<span class=p>)</span>
 
<span class=kd>const</span> <span class=p>(</span>
	<span class=nx>Bucket</span>           <span class=p>=</span> <span class=s>&#34;&lt;your-gae-default-bucket&gt;&#34;</span>
	<span class=nx>NotFoundImageURL</span> <span class=p>=</span> <span class=s>&#34;img-api-example/img404.jpg&#34;</span>
<span class=p>)</span>
 
<span class=cm>/**
</span><span class=cm> * index page
</span><span class=cm> */</span>
<span class=kd>func</span> <span class=nf>indexGET</span><span class=p>(</span><span class=nx>c</span> <span class=nx>echo</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>c</span><span class=p>.</span><span class=nf>Render</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;index.tpl&#34;</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
		<span class=s>&#34;title&#34;</span><span class=p>:</span> <span class=s>&#34;go gae image API example&#34;</span><span class=p>,</span>
		<span class=s>&#34;images&#34;</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
			<span class=s>&#34;img?f=img-api-example/1.png&#34;</span><span class=p>,</span>
			<span class=s>&#34;img?f=img-api-example/1.png&amp;s=200&#34;</span><span class=p>,</span>
			<span class=s>&#34;img?f=img-api-example/1.png&amp;s=200-c&#34;</span><span class=p>,</span>
			<span class=s>&#34;img?f=img-api-example/2.jpg&#34;</span><span class=p>,</span>
		<span class=p>},</span>
	<span class=p>})</span>
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
 
<span class=cm>/**
</span><span class=cm> * get not foound image default image, img404.jpg
</span><span class=cm> */</span>
<span class=kd>func</span> <span class=nf>getNotFoundImage</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>urlString</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>blobPath</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;/gs/%s/%s&#34;</span><span class=p>,</span> <span class=nx>Bucket</span><span class=p>,</span> <span class=nx>NotFoundImageURL</span><span class=p>)</span>
	<span class=nx>blobKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>blobstore</span><span class=p>.</span><span class=nf>BlobKeyForFile</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>blobPath</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>opts</span> <span class=o>:=</span> <span class=nx>image</span><span class=p>.</span><span class=nx>ServingURLOptions</span><span class=p>{</span><span class=nx>Secure</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>Crop</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
	<span class=nx>url</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>image</span><span class=p>.</span><span class=nf>ServingURL</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>blobKey</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>opts</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>urlString</span> <span class=p>=</span> <span class=nx>url</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
	<span class=k>return</span>
<span class=p>}</span>
 
<span class=cm>/**
</span><span class=cm> * image serve handler
</span><span class=cm> */</span>
<span class=kd>func</span> <span class=nf>imgServe</span><span class=p>(</span><span class=nx>c</span> <span class=nx>echo</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>appengine</span><span class=p>.</span><span class=nf>NewContext</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>Request</span><span class=p>().(</span><span class=o>*</span><span class=nx>standard</span><span class=p>.</span><span class=nx>Request</span><span class=p>).</span><span class=nx>Request</span><span class=p>)</span>
 
	<span class=nx>filePath</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>QueryParam</span><span class=p>(</span><span class=s>&#34;f&#34;</span><span class=p>)</span>
	<span class=nx>size</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>QueryParam</span><span class=p>(</span><span class=s>&#34;s&#34;</span><span class=p>)</span>
 
	<span class=nx>blobPath</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;/gs/%s/%s&#34;</span><span class=p>,</span> <span class=nx>Bucket</span><span class=p>,</span> <span class=nx>filePath</span><span class=p>)</span>
	<span class=nx>blobKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>blobstore</span><span class=p>.</span><span class=nf>BlobKeyForFile</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>blobPath</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusExpectationFailed</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
	<span class=p>}</span>
 
	<span class=nx>opts</span> <span class=o>:=</span> <span class=nx>image</span><span class=p>.</span><span class=nx>ServingURLOptions</span><span class=p>{</span><span class=nx>Secure</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>Crop</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
	<span class=k>if</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>image</span><span class=p>.</span><span class=nf>ServingURL</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>blobKey</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getNotFoundImage</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusTemporaryRedirect</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>size</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
			<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusTemporaryRedirect</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s=s%s&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>size</span><span class=p>))</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusTemporaryRedirect</span><span class=p>,</span> <span class=nx>url</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
		<span class=p>}</span>
	<span class=p>}</span>
 
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
 
<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>e</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexGET</span><span class=p>)</span>
	<span class=nx>e</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/img&#34;</span><span class=p>,</span> <span class=nx>imgServe</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><h3 id=gae-go-image-serve-gcs-image>GAE Go Image serve GCS image</h3><div class=fancybox><a data-fancybox=gallery href=https://kaichu.io/images/posts/gae-go-image-api.png data-caption><img src=https://kaichu.io/images/posts/gae-go-image-api.png></a></div><h3 id=demo-code>demo code</h3><p><a href=https://github.com/cage1016/gae-go-image-example>cage1016/gae-go-image-example: GAE go image API example</a></p></div><div class=post_footer><div class="post_content markdown"><h3>See Also</h3><ul><li><a href=/posts/managed-vms-lab/>Managed VMs lab</a></li><li><a href=/posts/gvm-install-go1-4/>解決 gvm install go1.4 安裝錯誤 [筆記]</a></li><li><a href=/posts/gae-link-pip-helper/>gae link pip helper</a></li><li><a href=/posts/gae-appcfg-update-403/>gae appcfg update 403</a></li><li><a href=/posts/gcsiterator/>GCSIterator (Python CSV iterator for Google Cloud Storage) via GAE</a></li></ul></div><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i><a href=https://kaichu.io/tags/gae/>GAE</a>
<a href=https://kaichu.io/tags/golang/>Golang</a>
<a href=https://kaichu.io/tags/echo/>echo</a>
<a href=https://kaichu.io/tags/pongor/>pongor</a></span></div></div></div></div><div class=doc_comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kaichu.io"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>My spiritual home</span></div></footer><script src=https://kaichu.io/js/jquery-3.5.1.min.js></script><link href=https://kaichu.io/css/fancybox.min.css rel=stylesheet><script src=https://kaichu.io/js/fancybox.min.js></script><script src=https://kaichu.io/js/zozo.js></script><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}});MathJax.Hub.Queue(function(){var all=MathJax.Hub.getAllJax(),i;for(i=0;i<all.length;i+=1){all[i].SourceElement().parentNode.className+=' has-jax';}});</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-65308340-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>