<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Skaffold debug goland · Kaichu.io</title><meta name="description" content="skaffold v38.0 開始支持 Go container debugging support，非常大程度解決先前 remote debug golang 的痛苦"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Skaffold debug goland</h1><div class="post-info">Oct 4, 2019</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>今年的 <a href="https://inthecloud.withgoogle.com/summit-tpe-19/agenda.html" target="_blank" rel="noopener">Google Cloud Summit 台北場</a> 於 9/24 在內湖萬豪酒店舉行，在主題演講中再次聽到 <a href="https://cloud.google.com/code" target="_blank" rel="noopener">Cloud Code</a> 的部份也看到比較有感覺的 Live demo</p>
<blockquote>
<p>Cloud Code 隨附的工具能協助您以輕鬆快速的方式編寫、部署及偵錯雲端原生的應用程式。這項產品提供 Visual Studio Code 和 IntelliJ 等 IDE 的擴充功能，方便您在 Kubernetes 上針對程式碼快速進行疊代、偵錯及部署等作業。<br>&nbsp;<br>Cloud Code 是基於 <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank" rel="noopener">GoogleContainerTools/skaffold: Easy and Repeatable Kubernetes Development</a> 為基礎上再整合 Visual Studio Code 和 IntelliJ IDE, 讓開發者可以直接在 IDE 上就可以快速開發 Kubernetes 上的應用程式</p>
</blockquote>
<p>基本上來說 Cloud Code 給 Visual Studio Code 和 IntelliJ IDE 的 plugin 就是基於 skaffold 打造的(如下圖)，當你在 Visual Studio Code 執行(cmd+shift+p) <code>Cloud Code: Continues Deploy</code> 的 log 就會知道</p>
<p><img src="/img/skaffold-go-debug-image-4.png" alt></p>
<a id="more"></a>
<h2 id="Cloud-Code-amp-debug"><a href="#Cloud-Code-amp-debug" class="headerlink" title="Cloud Code &amp; debug"></a>Cloud Code &amp; debug</h2><p>在談談 Skaffold debug k8s golang 的程式前，先來看看目前 Cloud Code debug 的部份支援幾種程式語言</p>
<p><em>Visual Studio Code 中 Cloud code 可以新增的專案範本</em></p>
<p><img src="/img/skaffold-go-debug-image-5.png" alt></p>
<blockquote>
<p>依照官方文件，現在 Cloud Code 有整合 debug 的部份有 <code>Node.js</code>、 <code>Python</code>、<code>Java</code>。 <code>Go</code> 目前不支援, 不過在 skaffold v38.0 的時候終於加進了. (Add Go container debugging support <a href="https://github.com/GoogleContainerTools/skaffold/pull/2306" target="_blank" rel="noopener">#2306</a>)，所以就有了這一篇文章。至於本來 Cloud Code 就有整合的語言就依照官方的操作流程應該就可以正常運作，所以這邊就不在說明了</p>
</blockquote>
<h2 id="Golang-debug-amp-skaffold"><a href="#Golang-debug-amp-skaffold" class="headerlink" title="Golang debug &amp; skaffold"></a>Golang debug &amp; skaffold</h2><p>當我們開發 kubernetes 應用程式(golang)會有 remote debug 的需求，在 skaffold v38.0 版之前 remote debug golang 是需要比較複雜的方式(docker-compose or kubernetes))</p>
<p><strong>之前我們怎麼進行 remote debug golang</strong></p>
<ol>
<li>編譯 binary 時需要加入 <code>github.com/derekparker/delve/cmd/dlv</code></li>
<li>執行 binary 時需要帶入 <code>CMD [&quot;/go/bin/dlv&quot;, &quot;--listen=:2345&quot;, &quot;--headless=true&quot;, &quot;--api-version=2&quot;, &quot;exec&quot;, &quot;/exe&quot;]</code></li>
<li><p>docker-compose &amp; kubernetes YAML 檔都需要加入額外的聲明(完整的 yaml 範例可以看 <a href="https://github.com/cage1016/gokitconsul/blob/master/deployments/docker/docker-compose-debug.yaml#L57-L85" target="_blank" rel="noopener">這</a>)</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">security_opt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apparmor:unconfined</span></span><br><span class="line"><span class="attr">cap_add:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SYS_PTRACE</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>需要 port forwarding dlv debug port 到本機</p>
</li>
<li>透過 localhost port forwarding 就可以 attach 到 remote 的 golang </li>
</ol>
<p>步驟有一點麻煩</p>
<p><strong>當 skaffold v38.0 開始支援 container debugging support，事情就變簡單了</strong></p>
<ol>
<li>remote debug 還是需要 <code>dlv</code>，不過 skaffold 透過 kubernetes 中的 initContainers 的方式來幫我們載入(Mount)相關的套件(dlv/dbg)，且會自動識別 runtime 來決定載入的套件，需 golang 的部份就在 <code>gcr.io/gcp-dev-tools/duct-tape/go</code>，(其他的 runtime 可由 <a href="https://github.com/GoogleContainerTools/container-debug-support/" target="_blank" rel="noopener">https://github.com/GoogleContainerTools/container-debug-support/</a> 查詢)，並且會在 metadata 的 anootation 中加上 <code>debug.cloud.google.com/config: {&quot;addsvc&quot;:{&quot;dlv&quot;:56268,&quot;runtime&quot;:&quot;go&quot;}}</code></li>
<li><p>remote debug 還是需要 <code>dlv</code> 相關的啟動參數，skaffold 會自動幫我載入 </p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Containers:</span></span><br><span class="line">    <span class="attr">addsvc:</span></span><br><span class="line">        <span class="attr">Container ID:</span>  <span class="string">docker://493a405f1dc0ee462f4e5f269ae2fdb352e8468c186cbb26905c42e0bf5675cf</span></span><br><span class="line">        <span class="attr">Image:</span>         <span class="string">cage1016/skaffold-debug-go-demo-addsvc:88f846061af2d34e8347a6325dcf48bb638f6baa50fd4599240fa5280054048e</span></span><br><span class="line">        <span class="attr">Image ID:</span>      <span class="string">docker://sha256:88f846061af2d34e8347a6325dcf48bb638f6baa50fd4599240fa5280054048e</span></span><br><span class="line">        <span class="attr">Ports:</span>         <span class="number">8020</span><span class="string">/TCP,</span> <span class="number">8021</span><span class="string">/TCP,</span> <span class="number">56268</span><span class="string">/TCP</span></span><br><span class="line">        <span class="attr">Host Ports:</span>    <span class="number">0</span><span class="string">/TCP,</span> <span class="number">0</span><span class="string">/TCP,</span> <span class="number">0</span><span class="string">/TCP</span></span><br><span class="line">        <span class="attr">Command:</span></span><br><span class="line">            <span class="string">/dbg/go/bin/dlv</span></span><br><span class="line">            <span class="string">exec</span></span><br><span class="line">            <span class="string">--headless</span></span><br><span class="line">            <span class="string">--continue</span></span><br><span class="line">            <span class="string">--accept-multiclient</span></span><br><span class="line">            <span class="string">--listen=localhost:56268</span></span><br><span class="line">            <span class="string">--api-version=2</span></span><br><span class="line">            <span class="string">/exe</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose &amp; kubernetes YAML <code>不</code>需要再加註其他的聲明</p>
</li>
<li>Cloud Code 上跑 skaffold debug 會自動幫我們建立 port forwarding</li>
<li>Cloud Code 上進行 deubg 的設定， <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"cloudcode"</span>,</span><br><span class="line">    <span class="attr">"language"</span>: <span class="string">"Go"</span>,</span><br><span class="line">    <span class="attr">"request"</span>: <span class="string">"attach"</span>,</span><br><span class="line">    <span class="attr">"debugPort"</span>: <span class="number">56268</span>,</span><br><span class="line">    <span class="attr">"localRoot"</span>: <span class="string">"$&#123;workspaceFolder&#125;/go"</span>,</span><br><span class="line">    <span class="attr">"remoteRoot"</span>: <span class="string">"/go/"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"skaffold-debug-go-demo"</span>,</span><br><span class="line">    <span class="attr">"podSelector"</span>: &#123;</span><br><span class="line">        <span class="attr">"app"</span>: <span class="string">"addsvc"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/2020/03/16/gae-custom-ws/" class="prev">PREV</a><a href="/2018/08/20/gdg-summit-2018-and-google-io-2018/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2019/10/04/skaffold-debug-goland/';
var disqus_title = 'Skaffold debug goland';
var disqus_url = 'http://kaichu.io/2019/10/04/skaffold-debug-goland/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>