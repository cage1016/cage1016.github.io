<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Screenshot as a Service · Kaichu.io</title><meta name="description" content="Simple demonstrate multiple way to create screenshot via phantomjs, chromeless and puppeteer and build screenshot as a service via GAE flex runtime."><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Screenshot as a Service</h1><div class="post-info">Sep 9, 2017</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><a href="https://gcpugtw.kktix.cc/events/meetup201709" target="_blank" rel="noopener">GCPUG Taiwan Meetup #29</a> Screenshot as a service</p>
<blockquote>
<p><a href="https://github.com/cage1016/screenshot-as-a-service-demo" target="_blank" rel="noopener">cage1016/screenshot-as-a-service-demo: GCPUG Taiwan Meetup #29: screenshot as a service demo code</a></p>
</blockquote>

	<iframe src="https://www.slideshare.net/slideshow/embed_code/key/o68LfhCpXHlFqz" style="width:100%;height:550px" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen> </iframe> <div style="margin-bottom:5px">


<a id="more"></a>
<h3 id="Waldo-gcp"><a href="#Waldo-gcp" class="headerlink" title="Waldo-gcp"></a>Waldo-gcp</h3><blockquote>
<p>一個基本 Google Map 上計算最佳路徑的實小服務</p>
</blockquote>
<p><img src="/img/screenshot-as-a-service-1.png" alt="waldo-gcp infrastructure"></p>
<p>當初會想弄一個 screenshot 的服務是因為 <a href="https://goo.gl/fnqLaZ" target="_blank" rel="noopener">slideshare: Waldo-gcp</a> 中會有擷圖的需求，且需要跟 GAE 進行整合，所以選擇了滿多人使用的 <a href="https://goo.gl/DT28P" target="_blank" rel="noopener">PhantomJS</a> 來實作擷圖的服務並使用 GAE flex runtime 的型式發佈到 GAE 平台上作為專案的 microservice 使用</p>
<h3 id="Phantomjs"><a href="#Phantomjs" class="headerlink" title="Phantomjs"></a>Phantomjs</h3><blockquote>
<p>PhantomJS is a headless WebKit scriptable with a JavaScript API. It has fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG.<br><a href="http://phantomjs.org/" target="_blank" rel="noopener">http://phantomjs.org/</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// yahoo.com.tw.js</span></span><br><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create();</span><br><span class="line">page.viewportSize = &#123; <span class="attr">width</span>: <span class="number">1440</span>, <span class="attr">height</span>: <span class="number">900</span> &#125;;</span><br><span class="line">page.clipRect = &#123; <span class="attr">top</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">0</span>, <span class="attr">width</span>: <span class="number">1440</span>, <span class="attr">height</span>: <span class="number">900</span> &#125;;</span><br><span class="line">page.open(<span class="string">'http://yahoo.com.tw'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  page.render(<span class="string">'yahoo.com.tw.png'</span>);</span><br><span class="line">  phantom.exit();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// execute</span></span><br><span class="line">$ phantomjs yahoo.com.tw.js</span><br></pre></td></tr></table></figure>
<h3 id="chromless"><a href="#chromless" class="headerlink" title="chromless"></a>chromless</h3><blockquote>
<p>Chrome automation made simple. Runs locally or headless on AWS Lambda.<br><a href="https://github.com/graphcool/chromeless" target="_blank" rel="noopener">https://github.com/graphcool/chromeless</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Chromeless &#125; = <span class="built_in">require</span>(<span class="string">'chromeless'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> chromeless = <span class="keyword">new</span> Chromeless()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> screenshot = <span class="keyword">await</span> chromeless</span><br><span class="line">    .goto(<span class="string">'https://www.google.com'</span>)</span><br><span class="line">    .type(<span class="string">'chromeless'</span>, <span class="string">'input[name="q"]'</span>)</span><br><span class="line">    .press(<span class="number">13</span>)</span><br><span class="line">    .wait(<span class="string">'#resultStats'</span>)</span><br><span class="line">    .screenshot()</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(screenshot) <span class="comment">// prints local file path or S3 url</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> chromeless.end()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run().catch(<span class="built_in">console</span>.error.bind(<span class="built_in">console</span>))</span><br></pre></td></tr></table></figure>
<h3 id="puppeteer"><a href="#puppeteer" class="headerlink" title="puppeteer"></a>puppeteer</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.google.com'</span>);</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'google.com.png'</span>&#125;);</span><br><span class="line"></span><br><span class="line">  browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>這兒舉三個簡單的例子來說明擷圖的技術，Phantomjs, Chromeless, puppeteer, 以前 Phantomjs 很熱門，不過最近 chromeless 等技術興起，也有友好的 API 可以給開發人員使用。<a href="https://goo.gl/cz4fSi" target="_blank" rel="noopener">GoogleChrome/puppeteer: Headless Chrome Node API</a> 更是提供高階 API 來操作 <a href="https://goo.gl/wg3u1W" target="_blank" rel="noopener">Headless</a> Chrome</p>
<h3 id="Screenshot-as-service-via-GAE-custom-runtime"><a href="#Screenshot-as-service-via-GAE-custom-runtime" class="headerlink" title="Screenshot as service via GAE custom runtime"></a>Screenshot as service via GAE custom runtime</h3><p><em>app.yaml</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runtime:</span> <span class="string">custom</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">flex</span></span><br><span class="line"><span class="attr">service:</span> <span class="string">screenshot</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">url:</span> <span class="string">/.*</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">app.js</span></span><br></pre></td></tr></table></figure>
<p>由於在兒我們使用的是包了 <a href="https://goo.gl/Ro4G" target="_blank" rel="noopener">Express</a> 及 <a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a> 的 custome runtime 來實作 GAE 版的 screenshot service, <code>yaml</code> 的重點便是指定 <code>runtime: custom</code>, <code>env: flex</code></p>
<p><em>dockerfile</em></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> launcher.gcr.io/google/debian8</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> DEBIAN_FRONTEND=noninteractive apt-get update -y &amp;&amp; apt-get install --no-install-recommends -y -q curl apt-utils build-essential ca-certificates libfreetype6 libfontconfig1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb http://http.debian.net/debian jessie-backports main"</span> &gt; /etc/apt/sources.list.d/backports.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get update -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y --no-install-recommends fonts-noto fonts-noto-cjk locales-all &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get autoclean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get autoremove &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /nodejs &amp;&amp; curl http://nodejs.org/dist/v0.12.1/node-v0.12.1-linux-x64.tar.gz | tar xvzf - -C /nodejs --strip-components=1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:/nodejs/bin</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> package.json /app/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/nodejs/bin/npm"</span>, <span class="string">"start"</span>]</span></span><br></pre></td></tr></table></figure>
<p><code>DockerFile</code> 的重點則是準備好基本的 library 及 Express/Phantomjs 的配置。準備好 <code>DockerFile</code>，<code>app.yaml</code> 還有程式碼，就可以透過 <code>gcloud -q app deploy</code> 的指命將服務推到 GCP 上</p>
<p><img src="/img/screenshot-as-a-service-2.png" alt="waldo-gcp screenshot as a service"></p>
<blockquote>
<p><a href="https://waldo-gcp-testbed.appspot.com/screenshot/usage.html" target="_blank" rel="noopener">https://waldo-gcp-testbed.appspot.com/screenshot/usage.html</a></p>
</blockquote>
</div></div></article></div></section><footer><div class="paginator"><a href="/2018/06/14/copy2clipboardwitheasy/" class="prev">PREV</a><a href="/2017/08/30/go-regex-notebook/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2017/09/09/screenshot-as-a-service/';
var disqus_title = 'Screenshot as a Service';
var disqus_url = 'http://kaichu.io/2017/09/09/screenshot-as-a-service/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>