<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>weddingcnp via GCP - 1. 專案架構切分 · Kaichu.io</title><meta name="description" content="weddingcnp 使用 dispatch.yaml 來進行專案架構上的切分，利用 makefile 來加速部署的流程、速度"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">weddingcnp via GCP - 1. 專案架構切分</h1><div class="post-info">Jun 12, 2017</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>此篇就對 <a href="http://weddingcnp.appspot.com/" target="_blank" rel="noopener">Cage &amp; Ping wedding</a> 中實作的專案架構進行簡單的說明，每一個 Google App Engine Service 實作的細節會在後序的篇幅中介紹</p>
<h4 id="weddingcnp-系例傳送門"><a href="#weddingcnp-系例傳送門" class="headerlink" title="weddingcnp 系例傳送門"></a>weddingcnp 系例傳送門</h4><ol>
<li><a href="https://kaichu.io/2017/06/08/weddingcnp-via-gcp/">weddingcnp via GCP 簡介</a></li>
<li><a href="https://kaichu.io/2017/06/12/weddingcnp-via-gcp-1/">weddingcnp via GCP - 1. 專案架構切分</a></li>
<li><a href="https://kaichu.io/2017/06/18/weddingcnp-via-gcp-2/">weddingcnp via GCP - 2. 前端頁面設計實作</a></li>
<li><a href="https://kaichu.io/2017/07/12/weddingcnp-via-gcp-3/">weddingcnp via GCP - 3. endpointAPI 設計實作</a></li>
<li>weddingcnp 前端 vue.js 設計實作</li>
<li>weddingcnp edm 寄送 sendgrid</li>
</ol>
<h4 id="weddingcnp-專案架構"><a href="#weddingcnp-專案架構" class="headerlink" title="weddingcnp 專案架構"></a>weddingcnp 專案架構</h4><p><a href="http://weddingcnp.appspot.com/" target="_blank" rel="noopener">Cage &amp; Ping wedding</a> 完全架構在 Google App Engine 上，再功能任務上需要達到幾個要求</p>
<ul>
<li>服務靜態頁面, 一堆的 html/css/javascript 及些許的動態資料</li>
<li>作為 API 的伺服器，收集前端表單送過來的資料並儲存至 Datastore 中</li>
<li>webmasters domain owner</li>
</ul>
<p><strong>project structure</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── endpoints               // endpoints instance</span><br><span class="line">│   ├── apis</span><br><span class="line">│   ├── handler</span><br><span class="line">│   ├── lib</span><br><span class="line">│   ├── app.py</span><br><span class="line">│   ├── app.pyc</span><br><span class="line">│   ├── app.yaml</span><br><span class="line">│   └── ...</span><br><span class="line">├── frontend                // frontend instance</span><br><span class="line">│   ├── public              // 公開資源</span><br><span class="line">│   │   ├── audio           // 音樂檔</span><br><span class="line">│   │   ├── css             // 靜態網頁用 css</span><br><span class="line">│   │   ├── images          // 靜態網頁用 image</span><br><span class="line">│   │   └── js              // 靜態網頁用 javascript</span><br><span class="line">│   ├── templates           // golang 模版</span><br><span class="line">│   │   ├── bingo.tmpl</span><br><span class="line">│   │   ├── .....</span><br><span class="line">│   │   └── rsvp.tmpl</span><br><span class="line">│   ├── app-engine.go</span><br><span class="line">│   ├── app-standalone.go</span><br><span class="line">│   ├── app.go</span><br><span class="line">│   ├── app.yaml</span><br><span class="line">│   ├── index.yaml</span><br><span class="line">│   └── main.go</span><br><span class="line">├── ownership               // webmaster instance</span><br><span class="line">│   ├── app.yaml</span><br><span class="line">│   └── googleae8f4bcce8bec00c.html</span><br><span class="line">├── dispatch.yaml           // dispatch.yaml</span><br><span class="line">└── makefile                // cli helper makefile</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>整個專案的檔案架構如上，可以分為 <code>endpoints</code>、<code>frontend</code>、<code>ownership</code> 三個 Service(Module), 而 Google App Engine 可以非常有彈性的透過 Service<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="Service == Module, 以前的名子叫作 Module, 後來改名為 Service，透過 `dispatch.yaml` 來指定，可以針對 Service 給予不同的 runtime、機器資源或是用另一種程式語言混搭
">[1]</span></a></sup> 的方式針對不同的任務給予不同資源<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[waldogcp](https://www.slideshare.net/cagechung/waldogcp) 一個也是基於 GCP 上建構出來的最佳路徑服務，亦使用 `dispatch.yaml` 來指派，對於服務中運算最重的部份(基因演算法)給予較大的機器
">[2]</span></a></sup>，而 <a href="http://weddingcnp.appspot.com/" target="_blank" rel="noopener">Cage &amp; Ping wedding</a> 基本上使用預計的部份就足夠了，不需特別指派</p>
<p><strong>dispatch.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dispatch:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"*/_ah/spi/*"</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"*/tasks/*"</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"*/favicon.ico"</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">frontend</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"*/googleae8f4bcce8bec00c.html"</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">ownership</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"*/*"</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<p>上述的 <code>dispatch.yaml</code> 可以幫我們重導流量至我們設定的 Service(Module)，不過在部署的部份則是需要一個一個 Service(Module)來進行部署，部署完之後會在 Google App Engine Services 中看到所有的 Services</p>
<p><img src="/img/weddingcnp-via-gcp-1_1.png" alt="Google App Engine Services"></p>
<p>再則我們可以透過 version<sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="將版號命名為 git 的 commit, 可以讓自己比較容易進行 Service 的版本管控
">[3]</span></a></sup> 的方式來管理部署的 Service</p>
<p><img src="/img/weddingcnp-via-gcp-1_2.png" alt="Google App Engine Version"></p>
<p>當 Google App Engine Service 切分的越細，雖然可以任務的資源給予更細的調整，不過卻也造成部署上的複雜度，因此可以透過 <code>mikefile</code> 來加速部署的流程與速度</p>
<p><strong>makefile</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ACCOUNT = cage.chung@gmail.com</span><br><span class="line">PROJECT = weddingcnp</span><br><span class="line">VERSION = b7484dd</span><br><span class="line"></span><br><span class="line">NODE_BIN = $(shell npm bin)</span><br><span class="line"></span><br><span class="line">set_config:</span><br><span class="line">	gcloud config <span class="built_in">set</span> account $(ACCOUNT)</span><br><span class="line">	gcloud config <span class="built_in">set</span> project $(PROJECT)</span><br><span class="line"></span><br><span class="line">install:</span><br><span class="line">	<span class="comment"># endpoints dependency pakcage</span></span><br><span class="line">	pip install -r endpoints/requirements.txt -t endpoints/lib</span><br><span class="line"></span><br><span class="line">run:</span><br><span class="line">	<span class="comment"># node devServer.js &amp;</span></span><br><span class="line">	<span class="comment">#goapp serve	dispatch.yaml frontend/app.yaml	endpoints/app.yaml ownership/app.yaml</span></span><br><span class="line">	dev_appserver.py dispatch.yaml frontend/app.yaml endpoints/app.yaml ownership/app.yaml --appidentity_email_address=save-avatar@weddingcnp.iam.gserviceaccount.com --appidentity_private_key_path=/Users/cage/.gvm/pkgsets/go1.7/global/src/github.com/cage1016/weddingcnp/endpoints/weddingcnp-3a652c96507d.pem --skip_sdk_update_check=yes --host 0.0.0.0 --enable_sendmail=yes</span><br><span class="line"></span><br><span class="line">update_frontend:</span><br><span class="line">	goapp deploy -application $(PROJECT) -version $(VERSION) frontend/app.yaml</span><br><span class="line"></span><br><span class="line">update_endpoints:</span><br><span class="line">	goapp deploy -application $(PROJECT) -version $(VERSION) endpoints/app.yaml</span><br><span class="line"></span><br><span class="line">update_ownership:</span><br><span class="line">	appcfg.py update --application=$(PROJECT) --version=1 ownership/app.yaml</span><br><span class="line"></span><br><span class="line">update_dispatch:</span><br><span class="line">	appcfg.py --application=$(PROJECT) --version=$(VERSION) update_dispatch .</span><br><span class="line"></span><br><span class="line">update_index:</span><br><span class="line">	appcfg.py --application=$(PROJECT) --version=$(VERSION) update_indexes endpoints</span><br><span class="line"></span><br><span class="line">update_queue:</span><br><span class="line">	appcfg.py --application=$(PROJECT) --version=$(VERSION) update_queues endpoints</span><br><span class="line"></span><br><span class="line">update: update_frontend update_endpoints update_ownership update_dispatch update_index update_queue</span><br></pre></td></tr></table></figure>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">Service == Module, 以前的名子叫作 Module, 後來改名為 Service，透過 <code>dispatch.yaml</code> 來指定，可以針對 Service 給予不同的 runtime、機器資源或是用另一種程式語言混搭<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://www.slideshare.net/cagechung/waldogcp" target="_blank" rel="noopener">waldogcp</a> 一個也是基於 GCP 上建構出來的最佳路徑服務，亦使用 <code>dispatch.yaml</code> 來指派，對於服務中運算最重的部份(基因演算法)給予較大的機器<a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">將版號命名為 git 的 commit, 可以讓自己比較容易進行 Service 的版本管控<a href="#fnref:3" rev="footnote"> ↩</a></span></li></ol></div></div></div></article></div></section><footer><div class="paginator"><a href="/2017/06/18/weddingcnp-via-gcp-2/" class="prev">PREV</a><a href="/2017/06/08/weddingcnp-via-gcp/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2017/06/12/weddingcnp-via-gcp-1/';
var disqus_title = 'weddingcnp via GCP - 1. 專案架構切分';
var disqus_url = 'http://kaichu.io/2017/06/12/weddingcnp-via-gcp-1/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>