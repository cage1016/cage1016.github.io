<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>golang serving a single page application · Kaichu.io</title><meta name="description" content="docker run small container with SPA serving by golang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">golang serving a single page application</h1><div class="post-info">Aug 4, 2016</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="golang-serve-SPA"><a href="#golang-serve-SPA" class="headerlink" title="golang serve SPA"></a>golang serve SPA</h2><p>最近有前端開發的需求，選用了 <a href="https://github.com/davezuko/react-redux-starter-kit" target="_blank" rel="noopener">react-redux-starter-kit</a> 來進行二次開發，省去一些想要使用 React, redux, redux-router 的基本配置，這樣速度會快一點</p>
<p>因為 <code>react-redux-starter-kit</code> 也使用 webpack 進行程式碼的打包, 所以最後的產出預設在 <code>dist</code> 資料夾中，所以部署時只需要一個簡單的 host server 即可</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dist example</span></span><br><span class="line">$ l</span><br><span class="line">total 752</span><br><span class="line">-rw-r--r--  1 cage  staff    3317 Aug  4 00:22 1.counter.fa53ea42bc9ff9de19bd.js</span><br><span class="line">-rw-r--r--  1 cage  staff  144953 Aug  4 00:22 app.5d0f2ab61ef7dd5daac5.js</span><br><span class="line">-rw-r--r--  1 cage  staff    2619 Aug  4 00:22 app.97a1751c9624097874a4b54cb93fa067.css</span><br><span class="line">-rw-r--r--  1 cage  staff     173 Aug  4 00:33 app.go</span><br><span class="line">-rw-r--r--  1 cage  staff   24838 Aug  4 00:22 favicon.ico</span><br><span class="line">-rw-r--r--  1 cage  staff     103 Aug  4 00:22 humans.txt</span><br><span class="line">-rw-r--r--  1 cage  staff     604 Aug  4 00:22 index.html</span><br><span class="line">-rw-r--r--  1 cage  staff      24 Aug  4 00:22 robots.txt</span><br><span class="line">-rw-r--r--  1 cage  staff  183224 Aug  4 00:22 vendor.9012d9d99074521f418e.js</span><br></pre></td></tr></table></figure>
<p>考慮效能的問題, 最後打算使用 golang 來當作 host server, golang 內建的 <code>net/http</code> 可以輕鬆的使用 <code>http.FileServer(http.Dir(&quot;./&quot;))</code> 來 host 整個靜態目錄</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"Listening port 3000..."</span>)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">":3000"</span>, http.FileServer(http.Dir(<span class="string">"./"</span>))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是上述的作法基本上是可以動的, 不過如果前端自己有使用到 <code>redux-router</code> 時, golang 並不會將請求導至前端的 router 而是直接得到 golang 404 而不會進到前端 redux-router 訂定的 router (如果有使用 redux-router 對 Notfound 進行處理)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/dfa</span><br></pre></td></tr></table></figure>
<p><img src="/img/golang-serve-static-site-404-golang.png" alt="golang 404 page"></p>
<p>所以我們使用了 golang <code>echo</code> 的 web framework, 監聽所有的請求並直接導至 <code>index.html</code> 的前端靜態檔案</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/labstack/echo"</span></span><br><span class="line">	<span class="string">"github.com/labstack/echo/engine/standard"</span></span><br><span class="line">	mw <span class="string">"github.com/labstack/echo/middleware"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	wwwRoot = <span class="string">"./"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	httpPort = flag.Int(<span class="string">"http"</span>, <span class="number">3000</span>, <span class="string">"http port number"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">echo</span>.<span class="title">Echo</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	e := echo.New()</span><br><span class="line"></span><br><span class="line">	e.Debug()</span><br><span class="line"></span><br><span class="line">	e.Use(mw.Logger())</span><br><span class="line">	e.Use(mw.Recover())</span><br><span class="line"></span><br><span class="line">	e.Any(<span class="string">"/*"</span>, echo.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(c echo.Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">		r := c.Request().(*standard.Request).Request</span><br><span class="line">		w := c.Response().(*standard.Response).ResponseWriter</span><br><span class="line"></span><br><span class="line">		requestPath := r.URL.Path</span><br><span class="line">		fileSystemPath := wwwRoot + r.URL.Path</span><br><span class="line">		endURIPath := strings.Split(requestPath, <span class="string">"/"</span>)[<span class="built_in">len</span>(strings.Split(requestPath, <span class="string">"/"</span>))<span class="number">-1</span>]</span><br><span class="line">		splitPath := strings.Split(endURIPath, <span class="string">"."</span>)</span><br><span class="line">		splitLength := <span class="built_in">len</span>(splitPath)</span><br><span class="line">		<span class="keyword">if</span> splitLength &gt; <span class="number">1</span> &amp;&amp; splitPath[splitLength<span class="number">-1</span>] != <span class="string">"go"</span> &#123;</span><br><span class="line">			f, error := os.Stat(fileSystemPath)</span><br><span class="line">			<span class="keyword">if</span> error == <span class="literal">nil</span> &amp;&amp; !f.IsDir() &#123;</span><br><span class="line">				http.ServeFile(w, r, fileSystemPath)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		http.ServeFile(w, r, wwwRoot+<span class="string">"index.html"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	server := Init()</span><br><span class="line">	server.Run(standard.New(fmt.Sprintf(<span class="string">`:%d`</span>, *httpPort)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/dfa</span><br></pre></td></tr></table></figure>
<p><img src="/img/golang-serve-static-site-404.jpg" alt="redux-router 404 page"></p>
<h2 id="run-SPA-as-with-docker-image"><a href="#run-SPA-as-with-docker-image" class="headerlink" title="run SPA as with docker image"></a>run SPA as with docker image</h2><p>處理完 golang 對 single page application 的支援, 進一步簡化部署的流程, 可以將整個 single page application 連同 <code>app.go</code> 利用 golang build 的方式編譯成執行檔, 再將 golang 執行檔透過 <code>Dockerfile</code> 編譯成 docker image, 這樣一來就可以很容易的部署在任何可以執行 container 的環境</p>
<p><img src="/img/golang-serve-static-site-flow.jpg" alt="flow"></p>
<p>上述一系列的流程我們可以使用 <code>npm run scripts</code> 的方式把它完全串起來來達到一鍵建立 docker image</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> cage.chung &lt;cage.chung@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /go</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /go/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"./counter"</span>]</span></span><br></pre></td></tr></table></figure>
<p>Dockerfile 檔案中我們需要指定 docker image 啟動時直接執行我們透過 <code>GOOS=linux GOARCH=amd64 go build -o counter</code> 編譯出來的執行檔 <code>counter*</code></p>
<p>執行自訂義 npm scripts <code>$ npm run docker</code> 成功執行後會自動建立 docker image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list docker image</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY                                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">username/counter                               v0.1.0              1771ddbe0a98        4 seconds ago       14.67 MB</span><br></pre></td></tr></table></figure>
<p>執行 docker image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run docker image</span></span><br><span class="line">$ docker run -d --name counter -p 3000:3000 username/counter:v0.1.0</span><br><span class="line">f8394fec624a4e3b989f7ce48857f64178e39aa8a5195f39e2d0d5a6572ee55c</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker ps</span></span><br><span class="line">$ dps</span><br><span class="line">CONTAINER ID        IMAGE                     COMMAND             CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">f8394fec624a        username/counter:v0.1.0   <span class="string">"./counter"</span>         2 seconds ago       Up 1 seconds        0.0.0.0:3000-&gt;3000/tcp   counter</span><br></pre></td></tr></table></figure>
<h2 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h2><p>Demo example <a href="https://github.com/cage1016/golang-serve-spa" target="_blank" rel="noopener">cage1016/golang-serve-spa</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone repo</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:cage1016/golang-serve-spa.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># npm install package</span></span><br><span class="line">$ npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一鍵建立 docker image</span></span><br><span class="line">$ npm docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker run</span></span><br><span class="line">$ docker run -d --name counter -p 3000:3000 username/counter:v0.1.0</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/22/retrain-inception-model-for-nas/" class="prev">PREV</a><a href="/2016/04/14/django-oscar-i18n/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2016/08/04/golang-serve-static-site/';
var disqus_title = 'golang serving a single page application';
var disqus_url = 'http://kaichu.io/2016/08/04/golang-serve-static-site/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>