<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Establishing a Websocket PUBSUB server with NATS and Google App Engine · Kaichu.io</title><meta name="description" content="透過 Google App Engine 和 NATS 建立 Websocket PUBSUB 伺服器"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Establishing a Websocket PUBSUB server with NATS and Google App Engine</h1><div class="post-info">Mar 16, 2020</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>在設計 API server 的時候會有遇到即時訊息傳遞的需求，同步可以用 GRPC 建立連線來溝通，為了降低系統的耦合性，可以選擇非同步的方式。而 PubSub 結合 websocket 是常用的方式。對於一位 Gopher 來說，<a href="https://nats.io/" target="_blank" rel="noopener">NATS</a> 是 <a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a> 下面中關於訊息傳遞的開源專案且對 Golang 友善(比 Kafka 好多了 XD)，選擇 <a href="https://nats.io/" target="_blank" rel="noopener">NATS</a> 的 PubSub 功能搭配 websocket 好像也是一個合理的選擇</p>
<a id="more"></a>
<p>在 Google App Engine 上搭建整個系統需要幾個知識點，讓我們一個一個來解釋，最後會附上完整的程式碼</p>
<p>Google App Engine 有一個很棒的功能是非常容易的建立 service，每一個 service 可以類比成 microservice。現在已經支援了 <code>Python</code>, <code>Java</code>, <code>Node.js</code>, <code>PHP</code>, <code>Runy</code>, <code>Go</code> 等幾種程式語言，也可以在 standard, flex, custom runtime (打包成 Docker 就不受到程式語言限制了) 中進行混搭，怎麼搭配就看題目進行選擇</p>
<p>不囉嗦，先看整個架構圖<br><img src="/img/gae-custom-ws-0.png" alt="infrastrucutre"></p>
<p>這邊我們有 3 個 service + 1 個 Google compute engine instance</p>
<ol>
<li>default (<code>us-central1</code>): 每一個 Google App Engine 一定要有一個 default service 且要第一個進行部署</li>
<li>add (<code>us-central1</code>): 核的的 service，提供 2 個 API，<code>sum</code> 和 <code>concat</code></li>
<li>ws (<code>us-central1</code>): 透過 <a href="https://nats.io/" target="_blank" rel="noopener">NATS</a> 的 client library + gorilla websocket 來實作</li>
<li>NATS (<code>asia-east1-b</code>): NATS 的 server</li>
</ol>
<h2 id="知識點"><a href="#知識點" class="headerlink" title="知識點"></a>知識點</h2><h4 id="Google-App-Engine-上實作-websocket-只能使用-flex-or-custom-runtime"><a href="#Google-App-Engine-上實作-websocket-只能使用-flex-or-custom-runtime" class="headerlink" title="## Google App Engine 上實作 websocket 只能使用 flex or custom runtime"></a>## Google App Engine 上實作 websocket 只能使用 flex or custom runtime</h4><p>這個是一個基本限制，如果在 Google App Engine 上有建立 websocket 的需求，只能選擇 <code>flex</code> or <code>custom</code> runtime. Google 官網有好幾個程式語言的範例<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Creating Persistent Connections with WebSockets](https://cloud.google.com/appengine/docs/flexible/go/using-websockets-and-session-affinity), 換程式語言也對應到相關的範例
">[1]</span></a></sup></p>
<h4 id="部著-NATS-server"><a href="#部著-NATS-server" class="headerlink" title="## 部著 NATS server"></a>## 部著 NATS server</h4><p>稍早提過，<a href="https://nats.io/" target="_blank" rel="noopener">NATS</a> 是 <a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a> 下面中關於訊息傳遞的開源專案且可以視為 cloud native (rock)，部署一個 NATS server 非常簡單。docker 就可以跑了，在 Google Cloud Platfrom 上我們可以透過 <a href="https://cloud.google.com/deployment-manager" target="_blank" rel="noopener">Cloud Deployment Manager</a> 一鍵部署一個 NATS Certified by Bitnami</p>
<p><img src="/img/gae-custom-ws-2.png" alt="NATS Certified by Bitnami"></p>
<p>部著成功之後可以查看到相關的訊息，包含要連線的密碼</p>
<h4 id="Google-App-Engine-Access-NATS-server-via-Serverless-VPC"><a href="#Google-App-Engine-Access-NATS-server-via-Serverless-VPC" class="headerlink" title="## Google App Engine Access NATS server via Serverless VPC"></a>## Google App Engine Access NATS server via Serverless VPC</h4><p>當我們一開始建立 Google App Engine 專案時我問我們要部署在什麼 region</p>
<ul>
<li><code>northamerica-northeast1</code> (Montréal)</li>
<li><code>us-central</code> (Iowa)</li>
<li><code>us-west2</code> (Los Angeles)</li>
<li><code>us-west3</code> (Salt Lake City)</li>
<li><code>us-east1</code> (South Carolina)</li>
<li><code>us-east4</code> (Northern Virginia)</li>
<li><code>southamerica-east1</code> (São Paulo)</li>
<li><code>europe-west</code> (Belgium)</li>
<li><code>europe-west2</code> (London)</li>
<li><code>europe-west3</code> (Frankfurt)</li>
<li><code>europe-west6</code> (Zürich)</li>
<li><code>asia-northeast1</code> (Tokyo)</li>
<li><code>asia-northeast2</code> (Osaka)</li>
<li><code>asia-northeast3</code> (Seoul)</li>
<li><code>asia-east2</code> (Hong Kong)</li>
<li><code>asia-south1</code> (Mumbai)</li>
<li><code>australia-southeast1</code> (Sydney)</li>
</ul>
<blockquote>
<p>asia 中日本，韓國，香港都有，台灣就是沒有，表示哭哭</p>
</blockquote>
<p>當我們使用 standard runtime 建立的應用程式有需要跟我們自己建立的 Google compute engine instance 進行溝通時，就必需透過 <code>VPC</code> 進行連線，阿不是在 GCP 專案下的機器是相通的嗎？</p>
<blockquote>
<p>一個簡單的判別方式，如果服務可以讓你設定 <code>network</code> 相關的設定就是；Google app engine standard runtime <code>app.yaml</code> 並沒有 <code>network</code> 相關可以配置的設定 (flex, custom runtime 中有)。而在 standard runtime 的 <code>beta</code> 中可以讓我們在 <code>app.yaml</code> 透過指定 <code>vpc_access_connector</code> 來 <a href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access" target="_blank" rel="noopener">Configuring Serverless VPC Access</a> 存取 Google compute engine<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="現在 `vpc_access_connector` 屬於 beta，所以在需要使用 `gcloud beta app deploy ...`">[2]</span></a></sup> 上相關的資源</p>
</blockquote>
<h4 id="透過-cloudbuild-部署整個-app-engine-application-需要的啟用的-API及權限"><a href="#透過-cloudbuild-部署整個-app-engine-application-需要的啟用的-API及權限" class="headerlink" title="## 透過 cloudbuild 部署整個 app engine application 需要的啟用的 API及權限"></a>## 透過 cloudbuild 部署整個 app engine application 需要的啟用的 API及權限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud app GROUP | COMMAND [GCLOUD_WIDE_FLAG ...]</span><br></pre></td></tr></table></figure>
<p>部署 Google app engine 的方式為使用 <code>gcloud</code> command，當數量少的時候可以手動進行部署，不過當 <code>service</code> 數量多時候，手動部署是很累人的，所以透過 <a href="https://cloud.google.com/cloud-build" target="_blank" rel="noopener">Cloud Build</a> 就是一個簡單的方式，要注意的部份是，在 local 時是以 <code>gcloud auth</code> 的身份進行部署，不過在 cloud build 中是透過 cloud build 的 service account (<a href="mailto:`xxx@cloudbuild.gserviceaccount.com" target="_blank" rel="noopener">`xxx@cloudbuild.gserviceaccount.com</a>`), 所以需在啟用相關的 API 及配置相關應的權限給 cloud build 的 service account 才不會報錯</p>
<p>需要特別啟用的 API</p>
<ul>
<li>Cloud Build API</li>
<li>App Engine Admin API: 在 Cloud build 中的設定直接 enable 就好</li>
<li>Serverless VPC Access API</li>
</ul>
<p><strong>cloudbuild.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">timeout:</span> <span class="string">1200s</span> <span class="comment"># 20 mins</span></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">deploy</span> <span class="string">website</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gcr.io/cloud-builders/gcloud</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">website/app.yaml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--version=$SHORT_SHA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--project=$PROJECT_ID</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-q</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">deploy</span> <span class="string">add</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gcr.io/cloud-builders/gcloud</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">beta</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cmd/add/app.yaml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--version=$SHORT_SHA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--project=$PROJECT_ID</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-q</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">build</span> <span class="string">ws</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gcr.io/cloud-builders/docker</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">bash</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-exc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">        <span class="string">docker</span> <span class="string">build</span> <span class="string">--tag</span> <span class="string">gcr.io/$PROJECT_ID/ws:$COMMIT_SHA</span> <span class="string">--tag</span> <span class="string">gcr.io/$PROJECT_ID/ws:$SHORT_SHA</span> <span class="string">--file</span> <span class="string">Dockerfile.ws</span> <span class="string">.</span></span><br><span class="line">        <span class="string">docker</span> <span class="string">push</span> <span class="string">gcr.io/$PROJECT_ID/ws:$COMMIT_SHA</span></span><br><span class="line">        <span class="string">docker</span> <span class="string">push</span> <span class="string">gcr.io/$PROJECT_ID/ws:$SHORT_SHA</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">deploy</span> <span class="string">ws</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gcr.io/cloud-builders/gcloud</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">beta</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cmd/ws/app.yaml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--version=$SHORT_SHA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--project=$PROJECT_ID</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--image-url=gcr.io/$PROJECT_ID/ws:$SHORT_SHA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-q</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">deploy</span> <span class="string">disptach</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gcr.io/cloud-builders/gcloud</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dispatch.yaml</span></span><br></pre></td></tr></table></figure>
<p>cloud build 中的流程是</p>
<ol>
<li>deploy website: default service, golang standard runtime</li>
<li>deploy add: add service, golang standard runtime</li>
<li>build ws docker image and push to gcr.io</li>
<li>deploy ws service, golang custom runtime</li>
<li>update disptach</li>
</ol>
<p>需要配置以下權限給 cloud build service account</p>
<ol>
<li><code>App Engine Admin</code>: cloud build deploy Google app engine</li>
<li><code>Cloud Build Service</code> Account: (default)</li>
<li><code>Compute Network User</code>: Access network</li>
<li><code>Serverless VPC Access User</code>: The “vpcaccess.connectors.use” permission is required.</li>
</ol>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p><img src="/img/gae-custom-ws-4.gif" alt="demo"></p>
<blockquote>
<p>Google app engine 還有一個佛心的部份就是自帶 HTTPS，所以我們實作的 websocket entrypoint 也可從 <code>ws://</code> 直接轉成 <code>wss://</code> (rock)</p>
</blockquote>
<h2 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h2><p><a href="https://github.com/cage1016/gae-custom-ws" target="_blank" rel="noopener">https://github.com/cage1016/gae-custom-ws</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://cloud.google.com/appengine/docs/flexible/go/using-websockets-and-session-affinity" target="_blank" rel="noopener">Creating Persistent Connections with WebSockets</a>, 換程式語言也對應到相關的範例<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">現在 <code>vpc_access_connector</code> 屬於 beta，所以在需要使用 <code>gcloud beta app deploy …</code><a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div></div></article></div></section><footer><div class="paginator"><a href="/2019/10/04/skaffold-debug-goland/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2020/03/16/gae-custom-ws/';
var disqus_title = 'Establishing a Websocket PUBSUB server with NATS and Google App Engine';
var disqus_url = 'http://kaichu.io/2020/03/16/gae-custom-ws/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>