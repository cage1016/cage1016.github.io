<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Google Announce Application Default Credentials (ADC) · Kaichu.io</title><meta name="description" content="今天 Google 公佈了 Application Default Credentials (ADC), 一個可以讓使用者更方便在 GCP 上去界接其他的需要使用 OAuth 存取的服務"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/customize.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kaichu.io/atom.xml" title="Kaichu.io"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/CageChung" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/cage1016" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.slideshare.net/cagechung" target="_blank" class="nav-list-link">SLIDESHARE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/kaichuchung" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Google Announce Application Default Credentials (ADC)</h1><div class="post-info">Jul 21, 2015</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>今天 Google 公佈了 <a href="http://googlecloudplatform.blogspot.tw/2015/07/Easier-Auth-for-Google-Cloud-APIs-Introducing-the-Application-Default-Credentials-feature.html" target="_blank" rel="noopener">Application Default Credentials (ADC)</a>，一個可以讓使用者更方便在 GCP 上去界接其他的需要使用 OAuth 存取的服務如 <a href="https://cloud-dot-devsite.googleplex.com/storage" target="_blank" rel="noopener">Google Cloud Storage</a>、<a href="https://cloud-dot-devsite.googleplex.com/bigquery" target="_blank" rel="noopener">Google BigQuery</a>。這對常常寫 GAE 的我來說又更方便了。</p>
<p>在 GCP 專案建立之後，預設會自動產生 <a href="https://developers.google.com/accounts/docs/OAuth2ServiceAccount" target="_blank" rel="noopener">Service Accounts</a>，<br>這些內建的 Service Accounts 在進行 Server to Server 的存取時只需要應用程式本身的認証，直接使用 <code>AppAssertionCredentials</code> 可以不需透過 <code>Flow</code> 來建立 <code>Credentials</code>物件</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httplib2</span><br><span class="line"><span class="keyword">from</span> google.appengine.api <span class="keyword">import</span> memcache</span><br><span class="line"><span class="keyword">from</span> apiclient.discovery <span class="keyword">import</span> build</span><br><span class="line"><span class="keyword">from</span> oauth2client.appengine <span class="keyword">import</span> AppAssertionCredentials</span><br><span class="line"></span><br><span class="line">credentials = AppAssertionCredentials(scope=<span class="string">'https://www.googleapis.com/auth/devstorage.full_control'</span>)</span><br><span class="line">http = credentials.authorize(httplib2.Http(memcache))</span><br><span class="line">gcs_service = build(<span class="string">'storage'</span>, <span class="string">'v1'</span>, http=http, developerKey=DEVELOPER_KEY)</span><br></pre></td></tr></table></figure>
<p>我們可以直接使用 <code>AppAssertionCredentials</code> 產生的 <code>credentials</code> 來建立 <code>gcs_service</code> 連線，這段程式在上傳到 GAE 上可以跑的很好，<br>不過如果你想要在本地測試的時候就需要特別指定 Server Accounts 的 <code>credentials</code></p>
<h2 id="Service-Accounts"><a href="#Service-Accounts" class="headerlink" title="Service Accounts"></a>Service Accounts</h2><p>Create Service Account</p>
<ol>
<li>Click <strong>APIs &amp; Auth</strong> &gt; <strong>credential</strong>.</li>
<li>Click <strong>Click new Client ID</strong>.</li>
<li>Choose <strong>Service Account</strong>.</li>
<li>Key type : <strong>P12 Key</strong></li>
<li>Click <strong>Create Client ID</strong></li>
<li><p><strong>P12.Key</strong> file will be downloaded. You have to convert <code>p12</code> to <code>pem</code> cause PKCS12 format is not supported by the PyCrypto library.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(openssl pkcs12 -<span class="keyword">in</span> xxxxx.p12 -nodes -nocerts &gt; privatekey.pem)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在本地測試程式時還需將 <code>--appidentity_email_address</code> 及 <code>--appidentity_private_key_path</code> 帶到 <code>dev_appserver.py</code> 參數中。<br>如果沒有帶入這二個參數本地測試會得到 <code>401 Unauthorized</code> 的錯誤訊息，不過上傳到 GAE 因為會透過應用程式本身的認証所以不會出錯。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gae run locally.</span></span><br><span class="line">dev_appserver.py yaml_or_war_path --appidentity_email_address=&lt;service-account-email&gt; --appidentity_private_key_path=&lt;privatekey.pem-path&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Application-Default-Credentials-ADC"><a href="#Application-Default-Credentials-ADC" class="headerlink" title="Application Default Credentials (ADC)"></a>Application Default Credentials (ADC)</h2><p>而 <a href="https://developers.google.com/identity/protocols/application-default-credentials" target="_blank" rel="noopener">Application Default Credentials</a> 則提供了更簡便的作法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oauth2client.client <span class="keyword">import</span> GoogleCredentials</span><br><span class="line"><span class="keyword">from</span> apiclient.discovery <span class="keyword">import</span> build</span><br><span class="line"></span><br><span class="line">credentials = GoogleCredentials.get_application_default()</span><br><span class="line">gcs_service = build(<span class="string">'storage'</span>, <span class="string">'v1'</span>, credentials=credentials)</span><br></pre></td></tr></table></figure>
<p>Application Default Credentials (ADC) 的方式在本地測試時因為直接使用了 <a href="https://cloud.google.com/sdk/gcloud/reference/auth/login" target="_blank" rel="noopener">gcloud auth login</a> 的 <code>credentials</code>，所以在開發上更方便更直覺。</p>
<p>注意事項:</p>
<ol>
<li><a href="https://developers.google.com/api-client-library/python/" target="_blank" rel="noopener">Google APIs Client Library for Python</a> 中 <code>1.3</code> 以上才支援 default credentials</li>
<li><code>$ gcloud -v</code> 確認 Google Cloud SDK 版本在 <code>0.9.51</code> 以上，Google App Engine SDK 版本在 <code>1.9.18</code> 以上</li>
</ol>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a href="http://googlecloudplatform.blogspot.tw/2015/07/Easier-Auth-for-Google-Cloud-APIs-Introducing-the-Application-Default-Credentials-feature.html" target="_blank" rel="noopener">Google Cloud Platform Blog: Easier Auth for Google Cloud APIs. Introducing the Application Default Credentials feature.</a></li>
<li><a href="https://developers.google.com/identity/protocols/application-default-credentials" target="_blank" rel="noopener">Google Application Default Credentials   |   Google Identity Platform   |   Google Developers</a></li>
<li><a href="https://developers.google.com/api-client-library/python/guide/google_app_engine" target="_blank" rel="noopener">Using Google App Engine   |   API Client Library for Python   |   Google Developers</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2015/07/27/gae-todomvc/" class="prev">PREV</a><a href="/2015/07/12/my-first-post/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'kaichuio';
var disqus_identifier = '2015/07/21/adc/';
var disqus_title = 'Google Announce Application Default Credentials (ADC)';
var disqus_url = 'http://kaichu.io/2015/07/21/adc/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kaichuio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://kaichu.io">KAI CHU CHUNG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65308340-1",'auto');ga('send','pageview');</script></body></html>